{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Pedro%20Henrique/Desktop/A-firma/website-ui/lib/server/results.ts"],"sourcesContent":["import { promises as fs } from \"fs\";\r\nimport path from \"path\";\r\n\r\nfunction repoRoot() {\r\n  return path.resolve(process.cwd(), \"..\");\r\n}\r\n\r\nexport function resultsRoot() {\r\n  const root = repoRoot();\r\n  return process.env.RESULTS_DIR || path.join(root, \"results\");\r\n}\r\n\r\nexport function indexPath() {\r\n  return path.join(resultsRoot(), \"results_index.json\");\r\n}\r\n\r\nexport async function readIndex() {\r\n  const p = indexPath();\r\n  const text = await fs.readFile(p, \"utf-8\");\r\n  return JSON.parse(text);\r\n}\r\n\r\nexport function resolveResultsPath(rel: string) {\r\n  const root = resultsRoot();\r\n  const target = path.resolve(root, rel);\r\n  const rootNorm = path.resolve(root);\r\n  if (!target.startsWith(rootNorm + path.sep) && target !== rootNorm) {\r\n    throw new Error(\"path_outside_results\");\r\n  }\r\n  return target;\r\n}\r\n\r\nexport function contentTypeFor(filePath: string) {\r\n  const ext = path.extname(filePath).toLowerCase();\r\n  if (ext === \".png\") return \"image/png\";\r\n  if (ext === \".jpg\" || ext === \".jpeg\") return \"image/jpeg\";\r\n  if (ext === \".svg\") return \"image/svg+xml\";\r\n  if (ext === \".pdf\") return \"application/pdf\";\r\n  if (ext === \".json\") return \"application/json\";\r\n  if (ext === \".csv\") return \"text/csv\";\r\n  if (ext === \".md\") return \"text/markdown\";\r\n  return \"application/octet-stream\";\r\n}\r\n"],"names":[],"mappings":";;;;;;;;;;;;AAAA;AACA;;;AAEA,SAAS;IACP,OAAO,4GAAI,CAAC,OAAO,CAAC,QAAQ,GAAG,IAAI;AACrC;AAEO,SAAS;IACd,MAAM,OAAO;IACb,OAAO,QAAQ,GAAG,CAAC,WAAW,IAAI,4GAAI,CAAC,IAAI,CAAC,MAAM;AACpD;AAEO,SAAS;IACd,OAAO,4GAAI,CAAC,IAAI,CAAC,eAAe;AAClC;AAEO,eAAe;IACpB,MAAM,IAAI;IACV,MAAM,OAAO,MAAM,yGAAE,CAAC,QAAQ,CAAC,GAAG;IAClC,OAAO,KAAK,KAAK,CAAC;AACpB;AAEO,SAAS,mBAAmB,GAAW;IAC5C,MAAM,OAAO;IACb,MAAM,SAAS,4GAAI,CAAC,OAAO,CAAC,MAAM;IAClC,MAAM,WAAW,4GAAI,CAAC,OAAO,CAAC;IAC9B,IAAI,CAAC,OAAO,UAAU,CAAC,WAAW,4GAAI,CAAC,GAAG,KAAK,WAAW,UAAU;QAClE,MAAM,IAAI,MAAM;IAClB;IACA,OAAO;AACT;AAEO,SAAS,eAAe,QAAgB;IAC7C,MAAM,MAAM,4GAAI,CAAC,OAAO,CAAC,UAAU,WAAW;IAC9C,IAAI,QAAQ,QAAQ,OAAO;IAC3B,IAAI,QAAQ,UAAU,QAAQ,SAAS,OAAO;IAC9C,IAAI,QAAQ,QAAQ,OAAO;IAC3B,IAAI,QAAQ,QAAQ,OAAO;IAC3B,IAAI,QAAQ,SAAS,OAAO;IAC5B,IAAI,QAAQ,QAAQ,OAAO;IAC3B,IAAI,QAAQ,OAAO,OAAO;IAC1B,OAAO;AACT"}},
    {"offset": {"line": 113, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Pedro%20Henrique/Desktop/A-firma/website-ui/app/api/graph/series-batch/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\nimport { promises as fs } from \"fs\";\nimport path from \"path\";\nimport { resultsRoot } from \"@/lib/server/results\";\n\nfunction parseCsv(text: string) {\n  const lines = text.trim().split(\"\\n\");\n  const header = (lines.shift()?.split(\",\") || []).map((h) => h.trim());\n  return lines.map((line) => {\n    const parts = line.split(\",\").map((p) => p.trim());\n    const row: Record<string, string> = {};\n    header.forEach((h, idx) => {\n      row[h] = parts[idx];\n    });\n    return row;\n  });\n}\n\nfunction toWeeklyIndices(dates: string[]) {\n  const out: number[] = [];\n  let lastKey = \"\";\n  for (let i = 0; i < dates.length; i += 1) {\n    const d = dates[i];\n    const dt = new Date(d + \"T00:00:00Z\");\n    const year = dt.getUTCFullYear();\n    const week = Math.ceil(((dt.getTime() - Date.UTC(year, 0, 1)) / 86400000 + 1) / 7);\n    const key = `${year}-W${week}`;\n    if (key !== lastKey) {\n      out.push(i);\n      lastKey = key;\n    } else {\n      out[out.length - 1] = i;\n    }\n  }\n  return out;\n}\n\nfunction std(values: number[]) {\n  if (!values.length) return 0;\n  const mean = values.reduce((a, b) => a + b, 0) / values.length;\n  const varSum = values.reduce((a, b) => a + (b - mean) ** 2, 0) / values.length;\n  return Math.sqrt(varSum);\n}\n\nfunction quantile(values: number[], q: number) {\n  if (!values.length) return 0;\n  const sorted = [...values].sort((a, b) => a - b);\n  const pos = (sorted.length - 1) * q;\n  const base = Math.floor(pos);\n  const rest = pos - base;\n  if (sorted[base + 1] !== undefined) {\n    return sorted[base] + rest * (sorted[base + 1] - sorted[base]);\n  }\n  return sorted[base];\n}\n\nfunction computeRegime(vol: number, q1: number, q2: number) {\n  if (vol <= q1) return \"STABLE\";\n  if (vol <= q2) return \"TRANSITION\";\n  return \"UNSTABLE\";\n}\n\nfunction computeConfidence(vol: number, minVol: number, maxVol: number) {\n  if (!Number.isFinite(vol) || maxVol <= minVol) return 0.6;\n  const rel = (vol - minVol) / (maxVol - minVol);\n  const conf = 0.6 + 0.3 * Math.abs(rel - 0.5) * 2;\n  return Math.max(0.55, Math.min(0.9, conf));\n}\n\nasync function loadFallbackSeries(asset: string, tf: string, limit: number, step: number) {\n  const priceFile = path.join(resultsRoot(), \"..\", \"data\", \"raw\", \"finance\", \"yfinance_daily\", `${asset}.csv`);\n  const rawPrice = await fs.readFile(priceFile, \"utf-8\");\n  const priceRows = parseCsv(rawPrice);\n  const dates = priceRows.map((r) => r.date).filter(Boolean);\n  const returns = priceRows.map((r) => Number(r.r)).filter((v) => Number.isFinite(v));\n\n  const window = 20;\n  const volSeries: number[] = [];\n  for (let i = window; i < returns.length; i += 1) {\n    const slice = returns.slice(i - window, i);\n    volSeries.push(std(slice));\n  }\n\n  const q1 = quantile(volSeries, 0.33);\n  const q2 = quantile(volSeries, 0.66);\n  const minVol = Math.min(...volSeries, q1);\n  const maxVol = Math.max(...volSeries, q2);\n\n  const seriesRaw = priceRows.map((row, idx) => {\n    const vol = volSeries[idx - window] ?? volSeries[volSeries.length - 1] ?? 0;\n    const regime = computeRegime(vol, q1, q2);\n    const confidence = computeConfidence(vol, minVol, maxVol);\n    return {\n      date: row.date,\n      confidence,\n      regime,\n      price: Number(row.price ?? NaN) || null,\n    };\n  });\n\n  let indices: number[] = [];\n  if (tf === \"weekly\") {\n    indices = toWeeklyIndices(dates);\n  } else {\n    indices = seriesRaw.map((_, idx) => idx);\n  }\n\n  const sliced = indices.map((i) => seriesRaw[i]).filter((r) => r && r.date);\n  const total = sliced.length;\n  const n = limit ? Math.min(limit, total) : total;\n  return sliced.slice(-n).filter((_, idx) => idx % step === 0);\n}\n\nexport async function GET(request: Request) {\n  const { searchParams } = new URL(request.url);\n  const assetsParam = searchParams.get(\"assets\");\n  const tf = searchParams.get(\"tf\") || \"weekly\";\n  const limitParam = searchParams.get(\"limit\");\n  const stepParam = searchParams.get(\"step\");\n  const limit = limitParam ? Math.max(1, Number(limitParam)) : 0;\n  const step = stepParam ? Math.max(1, Number(stepParam)) : 1;\n  if (!assetsParam) {\n    return NextResponse.json({ error: \"missing_assets\" }, { status: 400 });\n  }\n  const assets = assetsParam.split(\",\").map((s) => s.trim()).filter(Boolean);\n  const out: Record<\n    string,\n    { date: string; confidence: number; regime: string; price: number | null }[]\n  > = {};\n\n  await Promise.all(\n    assets.map(async (asset) => {\n      try {\n        const regimesFile = path.join(resultsRoot(), \"latest_graph\", \"assets\", `${asset}_${tf}_regimes.csv`);\n        const rawReg = await fs.readFile(regimesFile, \"utf-8\");\n        const regRows = parseCsv(rawReg);\n\n        const priceFile = path.join(resultsRoot(), \"..\", \"data\", \"raw\", \"finance\", \"yfinance_daily\", `${asset}.csv`);\n        const rawPrice = await fs.readFile(priceFile, \"utf-8\");\n        const priceRows = parseCsv(rawPrice);\n        const dates = priceRows.map((r) => r.date).filter(Boolean);\n        const indices = tf === \"weekly\" ? toWeeklyIndices(dates) : priceRows.map((_, idx) => idx);\n\n        const total = regRows.length;\n        const n = limit ? Math.min(limit, total) : total;\n        const sliceRegs = regRows.slice(-n);\n        const sliceIdx = indices.slice(-n);\n        const series = sliceRegs\n          .filter((_, idx) => idx % step === 0)\n          .map((r, i) => {\n            const priceRow = priceRows[sliceIdx[i] ?? 0];\n            return {\n              date: priceRow?.date || \"\",\n              confidence: Number(r.confidence),\n              regime: r.regime,\n              price: Number(priceRow?.price ?? NaN) || null,\n            };\n          });\n        out[asset] = series;\n      } catch {\n        try {\n          out[asset] = await loadFallbackSeries(asset, tf, limit, step);\n        } catch {\n          out[asset] = [];\n        }\n      }\n    })\n  );\n\n  return NextResponse.json(out);\n}\r\n"],"names":[],"mappings":"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"}}]
}
{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Pedro%20Henrique/Desktop/A-firma/website-ui/app/api/graph/universe/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\nimport { promises as fs } from \"fs\";\nimport path from \"path\";\n\nfunction repoRoot() {\n  return path.resolve(process.cwd(), \"..\");\n}\n\nfunction parseCsv(text: string) {\n  const lines = text.trim().split(\"\\n\");\n  const header = (lines.shift()?.split(\",\") || []).map((h) => h.trim());\n  return lines.map((line) => {\n    const parts = line.split(\",\");\n    const row: Record<string, string> = {};\n    header.forEach((h, idx) => {\n      row[h] = (parts[idx] || \"\").trim();\n    });\n    return row;\n  });\n}\n\nfunction std(values: number[]) {\n  if (!values.length) return 0;\n  const mean = values.reduce((a, b) => a + b, 0) / values.length;\n  const varSum = values.reduce((a, b) => a + (b - mean) ** 2, 0) / values.length;\n  return Math.sqrt(varSum);\n}\n\nfunction quantile(values: number[], q: number) {\n  if (!values.length) return 0;\n  const sorted = [...values].sort((a, b) => a - b);\n  const pos = (sorted.length - 1) * q;\n  const base = Math.floor(pos);\n  const rest = pos - base;\n  if (sorted[base + 1] !== undefined) {\n    return sorted[base] + rest * (sorted[base + 1] - sorted[base]);\n  }\n  return sorted[base];\n}\n\nfunction computeRegime(vol: number, q1: number, q2: number) {\n  if (vol <= q1) return \"STABLE\";\n  if (vol <= q2) return \"TRANSITION\";\n  return \"UNSTABLE\";\n}\n\nfunction computeConfidence(vol: number, minVol: number, maxVol: number) {\n  if (!Number.isFinite(vol) || maxVol <= minVol) return 0.6;\n  const rel = (vol - minVol) / (maxVol - minVol);\n  const conf = 0.6 + 0.3 * Math.abs(rel - 0.5) * 2;\n  return Math.max(0.55, Math.min(0.9, conf));\n}\n\nexport async function GET(request: Request) {\n  const { searchParams } = new URL(request.url);\n  const tf = searchParams.get(\"tf\") || \"weekly\";\n  const file = tf === \"daily\" ? \"universe_daily.json\" : \"universe_weekly.json\";\n  const target = path.join(repoRoot(), \"results\", \"latest_graph\", file);\n  try {\n    const text = await fs.readFile(target, \"utf-8\");\n    return NextResponse.json(JSON.parse(text));\n  } catch {\n    // fallback from asset_groups.csv + price data\n    try {\n      const groupsCsv = await fs.readFile(path.join(repoRoot(), \"data\", \"asset_groups.csv\"), \"utf-8\");\n      const groups = parseCsv(groupsCsv);\n      const out = [] as any[];\n      for (const row of groups) {\n        const asset = row.asset;\n        const group = row.group;\n        try {\n          const priceFile = path.join(repoRoot(), \"data\", \"raw\", \"finance\", \"yfinance_daily\", `${asset}.csv`);\n          const raw = await fs.readFile(priceFile, \"utf-8\");\n          const rows = parseCsv(raw);\n          const returns = rows.map((r) => Number(r.r)).filter((v) => Number.isFinite(v));\n          const window = 20;\n          const volSeries: number[] = [];\n          for (let i = window; i < returns.length; i++) {\n            const slice = returns.slice(i - window, i);\n            volSeries.push(std(slice));\n          }\n          const q1 = quantile(volSeries, 0.33);\n          const q2 = quantile(volSeries, 0.66);\n          const minVol = Math.min(...volSeries, q1);\n          const maxVol = Math.max(...volSeries, q2);\n          const lastVol = volSeries[volSeries.length - 1] ?? 0;\n          const regime = computeRegime(lastVol, q1, q2);\n          const confidence = computeConfidence(lastVol, minVol, maxVol);\n          out.push({\n            asset,\n            group,\n            state: { label: regime },\n            metrics: { confidence },\n          });\n        } catch {\n          out.push({ asset, group, state: { label: \"TRANSITION\" }, metrics: { confidence: 0.6 } });\n        }\n      }\n      return NextResponse.json(out);\n    } catch {\n      return NextResponse.json({ error: \"graph_universe_not_found\" }, { status: 404 });\n    }\n  }\n}\r\n"],"names":[],"mappings":"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"}}]
}